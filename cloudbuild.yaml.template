steps:
  # Build the container image
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'us-central1-docker.pkg.dev/reeled-ai-production/docker-repo/reeled-ai-v2', '.']
  
  # Push the container image to Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'us-central1-docker.pkg.dev/reeled-ai-production/docker-repo/reeled-ai-v2']

  # Deploy container image to Cloud Run
  # NOTE: Use --set-secrets flag instead of hardcoding API keys in --set-env-vars
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - 'reeled-ai-v2'
      - '--image'
      - 'us-central1-docker.pkg.dev/reeled-ai-production/docker-repo/reeled-ai-v2'
      - '--platform'
      - 'managed'
      - '--region'
      - 'us-central1'
      - '--allow-unauthenticated'
      - '--memory'
      - '2Gi'
      - '--cpu'
      - '2'
      - '--min-instances'
      - '0'
      - '--max-instances'
      - '10'
      - '--port'
      - '8080'
      - '--timeout'
      - '300'
      # Use secrets from Secret Manager instead of hardcoded values
      - '--set-secrets'
      - 'GEMINI_API_KEY=gemini-api-key:latest,NEXT_PUBLIC_GEMINI_API_KEY=gemini-api-key:latest,AZURE_OPENAI_API_KEY=azure-openai-api-key:latest,NEXT_PUBLIC_AZURE_OPENAI_API_KEY=azure-openai-api-key:latest'
      - '--set-env-vars'
      - 'NODE_ENV=production,NEXT_TELEMETRY_DISABLED=1,USE_GEMINI_ONLY=true,PRIMARY_MODEL=gemini,GEMINI_STABLE_MODE_MODEL=gemini-2.5-pro,AZURE_OPENAI_ENDPOINT=https://reeled-ai-alpha.openai.azure.com/,AZURE_OPENAI_API_VERSION=2024-12-01-preview,AZURE_OPENAI_DEPLOYMENT=gpt-4.1,NEXT_PUBLIC_GEMINI_STABLE_MODE_MODEL=gemini-2.5-pro,NEXT_PUBLIC_USE_GEMINI_ONLY=true,NEXT_PUBLIC_PRIMARY_MODEL=gemini,NEXT_PUBLIC_AZURE_OPENAI_ENDPOINT=https://reeled-ai-alpha.openai.azure.com/,NEXT_PUBLIC_AZURE_OPENAI_API_VERSION=2024-12-01-preview,NEXT_PUBLIC_AZURE_OPENAI_DEPLOYMENT=gpt-4.1,GPT_4_1_DEPLOYMENT=gpt-4.1,GPT_5_MINI_DEPLOYMENT=gpt-5-mini,GPT_4O_DEPLOYMENT=gpt-4o-2024-11-20,NEXT_PUBLIC_GPT_4_1_DEPLOYMENT=gpt-4.1,NEXT_PUBLIC_GPT_5_MINI_DEPLOYMENT=gpt-5-mini,NEXT_PUBLIC_GPT_4O_DEPLOYMENT=gpt-4o-2024-11-20,NEXT_PUBLIC_FIREBASE_API_KEY=AIzaSyB6yfJSsYGBE3m0B0kslIMJ86cSktV5w3U,NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=greenlitai.firebaseapp.com,NEXT_PUBLIC_FIREBASE_PROJECT_ID=greenlitai,NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=greenlitai.firebasestorage.app,NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=42640188111,NEXT_PUBLIC_FIREBASE_APP_ID=1:42640188111:web:89e69efb3cf94522ac8dba,NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=G-VZNLRYMNH0'

images:
  - 'us-central1-docker.pkg.dev/reeled-ai-production/docker-repo/reeled-ai-v2'

timeout: 1800s

