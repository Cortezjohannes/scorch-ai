rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Test collection for connection testing (temporary)
    match /connection_test/{document=**} {
      allow read, write: if true;
    }
    
    // User profile documents
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // User projects (nested under users)
    match /users/{userId}/projects/{projectId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // User story bibles (nested under users)
    match /users/{userId}/storyBibles/{storyBibleId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Episodes nested under story bibles
      match /episodes/{episodeId} {
        // Only owner can access their story bible's episodes
        // Ensure storyBibleId in document matches path on create/update
        allow read: if request.auth != null && request.auth.uid == userId;
        allow create, update: if request.auth != null && 
                                request.auth.uid == userId &&
                                request.resource.data.storyBibleId == storyBibleId;
        allow delete: if request.auth != null && request.auth.uid == userId;
      }
      
      // Pre-production nested under story bibles
      match /preproduction/{preProductionId} {
        // Only owner can access their story bible's pre-production
        allow read, write: if request.auth != null && request.auth.uid == userId;
        
        // Ensure storyBibleId in document matches path on create/update
        allow create, update: if request.auth != null && 
                                request.auth.uid == userId &&
                                request.resource.data.storyBibleId == storyBibleId;
      }
      
      // Version history subcollection
      match /versions/{versionId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Episode reflections subcollection
      match /reflections/{episodeId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Actor materials nested under story bibles
      match /actorMaterials/{materialId} {
        // Only owner can access their story bible's actor materials
        allow read, write: if request.auth != null && request.auth.uid == userId;
        
        // Ensure storyBibleId in document matches path on create/update
        allow create, update: if request.auth != null && 
                                request.auth.uid == userId &&
                                request.resource.data.storyBibleId == storyBibleId;
      }
    }
    
    // User templates collection
    match /users/{userId}/templates/{templateId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Image cache collection - user-specific cache for generated images
    match /users/{userId}/imageCache/{promptHash} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // ========== STORY BIBLE SHARING FEATURE ==========
    
    // Shared story bibles - PUBLIC read, authenticated create, restricted update
    match /sharedStoryBibles/{shareId} {
      allow read: if true; // public read
      allow create: if request.auth != null; // authenticated users can create
      allow update: if isValidShareLink(shareId); // only update if link is valid
      allow delete: if request.auth != null && 
                       resource.data.ownerId == request.auth.uid; // owner can delete
    }
    
    // Share link management
    match /shareLinks/{linkId} {
      allow read: if true; // public read to validate links
      allow create: if request.auth != null && 
                       request.resource.data.ownerId == request.auth.uid;
      allow update: if request.auth != null && 
                       resource.data.ownerId == request.auth.uid;
      allow delete: if request.auth != null && 
                       resource.data.ownerId == request.auth.uid;
    }
    
    // ========== INVESTOR/PITCH MATERIALS SHARING FEATURE ==========
    
    // Shared investor materials - PUBLIC read, authenticated create, restricted update
    match /sharedInvestorMaterials/{linkId} {
      allow read: if true; // public read
      allow create: if request.auth != null; // authenticated users can create
      allow update: if request.auth != null && 
                       resource.data.ownerId == request.auth.uid; // owner can update
      allow delete: if request.auth != null && 
                       resource.data.ownerId == request.auth.uid; // owner can delete
      
      // Character details subcollection
      match /characters/{characterName} {
        allow read: if true; // public read (part of shared materials)
        allow write: if request.auth != null; // authenticated users can write when creating/updating the parent
      }
    }
    
    // Investor link management
    match /investorLinks/{linkId} {
      allow read: if true; // public read to validate links
      allow create: if request.auth != null && 
                       request.resource.data.ownerId == request.auth.uid;
      allow update: if request.auth != null && 
                       resource.data.ownerId == request.auth.uid;
      allow delete: if request.auth != null && 
                       resource.data.ownerId == request.auth.uid;
    }
    
    // Helper function to validate share links
    function isValidShareLink(shareId) {
      let link = getAfter(/databases/$(database)/documents/shareLinks/$(shareId));
      return link != null && 
             link.data.isActive == true && 
             (link.data.expiresAt == null || link.data.expiresAt > request.time);
    }
  }
}

